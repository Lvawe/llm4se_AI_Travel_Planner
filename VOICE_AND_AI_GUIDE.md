# 语音输入和 AI 行程规划功能使用指南

## 🎤 语音输入功能

### 功能说明
- 使用浏览器自带的语音识别 API（Web Speech API）
- 支持中文语音识别
- 实时显示识别结果
- 自动追加到行程描述中

### 使用步骤
1. 在创建新行程页面，找到"行程描述"输入框
2. 点击 🎤 麦克风图标
3. 允许浏览器使用麦克风权限
4. 开始说话，语音会实时转换为文字
5. 点击"停止录音"按钮完成输入
6. 识别的文字会自动追加到描述框中

### 浏览器兼容性
- ✅ Chrome/Edge（推荐）
- ✅ Safari（macOS/iOS）
- ❌ Firefox（暂不支持）

### 注意事项
- 首次使用需要授权麦克风权限
- 需要在 HTTPS 环境下使用（localhost 除外）
- 确保环境相对安静以获得更好的识别效果

---

## 🤖 AI 行程规划功能

### 功能说明
- 使用阿里云百炼平台的通义千问 AI
- 根据目的地、日期、预算、人数和偏好生成个性化行程
- 包含详细的每日行程、预算分配和旅行建议
- 自动回退机制，API 失败时使用默认模板

### 使用步骤
1. 填写必填信息：
   - ✅ 目的地（例如：北京、上海、成都）
   - ✅ 开始日期
   - ✅ 结束日期

2. 填写可选信息（可提高 AI 规划质量）：
   - 预算
   - 出行人数
   - 旅行偏好（美食、购物、自然风光等）
   - 行程描述（使用语音输入更方便）

3. 点击 **"✨ AI 智能生成行程"** 按钮

4. 等待 AI 生成（通常 3-5 秒）

5. 查看生成的行程计划：
   - 📅 **行程安排**：每天的详细活动
   - 💰 **预算明细**：交通、住宿、餐饮等分项
   - 💡 **旅行建议**：当地特色、注意事项等

6. 满意后点击"创建行程"保存

### AI 生成的内容示例

#### 行程安排
```
第1天：抵达与市区探索
• 抵达目的地，办理入住
• 参观市中心著名景点
• 品尝当地特色美食
• 傍晚漫步老街区

第2天：文化深度游
• 上午参观博物馆
• 下午探访古建筑
• 晚上观看地方演出
```

#### 预算明细
```
交通：¥800
住宿：¥1200
餐饮：¥600
门票：¥400
其他：¥200
```

#### 旅行建议
```
💡 提前预订热门景点门票
💡 尝试当地特色小吃
💡 注意防晒和保暖
💡 推荐早起游览人少的景点
```

---

## 🔄 完整工作流程

### 推荐使用流程

1. **填写基本信息**
   ```
   目的地：成都
   日期：2024-12-01 到 2024-12-05
   预算：5000 元
   人数：2 人
   ```

2. **选择旅行偏好**
   - 勾选：美食 ✓、历史文化 ✓、休闲放松 ✓

3. **使用语音输入描述需求**
   - 点击麦克风图标
   - 说："我想在成都体验正宗川菜，参观熊猫基地，逛逛宽窄巷子，感受当地慢生活节奏"
   - 语音自动转换为文字

4. **AI 生成行程**
   - 点击"AI 智能生成行程"
   - 查看 AI 生成的详细计划
   - 可以修改任何内容

5. **保存行程**
   - 点击"创建行程"
   - 行程保存到数据库
   - 跳转到行程详情页

---

## 🛠️ 技术实现

### 语音输入
- **前端组件**：`/frontend/src/components/VoiceInput.tsx`
- **API**：浏览器 Web Speech API
- **语言设置**：zh-CN（中文）
- **实现方式**：
  ```typescript
  const recognition = new webkitSpeechRecognition()
  recognition.lang = 'zh-CN'
  recognition.continuous = false
  recognition.interimResults = true
  ```

### AI 规划
- **后端服务**：`/backend/src/services/llmService.ts`
- **API 路由**：`/backend/src/routes/ai.ts`
- **端点**：`POST /api/ai/generate-plan`
- **AI 模型**：阿里云通义千问 (qwen-turbo)
- **实现方式**：
  ```typescript
  // 调用 DashScope API
  const response = await axios.post(
    'https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation',
    payload,
    { headers: { Authorization: `Bearer ${API_KEY}` } }
  )
  ```

### 数据存储
- **数据库字段**：
  - `description`: 用户输入的行程描述（支持语音输入）
  - `itinerary`: JSON 格式存储 AI 生成的完整计划
- **Prisma Schema**：
  ```prisma
  model Trip {
    description String?  // 行程描述
    itinerary   Json?    // AI 生成的计划
  }
  ```

---

## 🔧 配置说明

### 环境变量

**后端** (`/backend/.env`)：
```bash
# 阿里云百炼 API 配置
DASHSCOPE_API_KEY=your_api_key_here
LLM_MODEL=qwen-turbo

# 数据库配置
DATABASE_URL=postgresql://...
BACKEND_PORT=3001
JWT_SECRET=your_jwt_secret
```

**前端** (`/frontend/.env.local`)：
```bash
# API 地址
NEXT_PUBLIC_API_URL=http://localhost:3001

# 高德地图 API Key
NEXT_PUBLIC_AMAP_KEY=your_amap_key_here
```

### API Key 获取

1. **阿里云百炼**：https://bailian.console.aliyun.com/
2. **高德地图**：https://console.amap.com/

---

## 🐛 常见问题

### Q1: 语音识别不工作？
**A**: 
- 检查浏览器兼容性（推荐 Chrome）
- 确保已授权麦克风权限
- 在 localhost 或 HTTPS 环境下使用

### Q2: AI 生成失败？
**A**: 
- 检查 `DASHSCOPE_API_KEY` 是否正确配置
- 查看后端日志是否有错误信息
- 系统会自动使用默认模板作为回退

### Q3: 行程创建失败？
**A**: 
- 确保填写了必填字段（目的地、日期）
- 检查后端服务是否正常运行
- 查看浏览器控制台的错误信息

### Q4: 语音识别准确度不高？
**A**: 
- 确保环境安静
- 说话清晰、语速适中
- 可以多次录音并手动修改

---

## 📊 功能测试清单

### 语音输入测试
- [ ] 点击麦克风图标显示语音输入界面
- [ ] 授权麦克风权限
- [ ] 开始录音，看到实时识别结果
- [ ] 停止录音，文字追加到描述框
- [ ] 多次使用语音输入，文字正确追加

### AI 规划测试
- [ ] 填写目的地、日期等信息
- [ ] 点击"AI 智能生成行程"按钮
- [ ] 显示加载状态（"AI 规划中..."）
- [ ] 生成成功，显示行程计划
- [ ] 行程安排、预算明细、旅行建议都正确显示
- [ ] 创建行程时 AI 计划被保存

### 集成测试
- [ ] 使用语音输入填写描述
- [ ] 基于语音描述生成 AI 行程
- [ ] 查看并编辑 AI 生成的内容
- [ ] 保存行程到数据库
- [ ] 在行程详情页查看保存的 AI 计划

---

## 🚀 未来优化方向

1. **语音输入增强**
   - 支持更多语言
   - 实时标点符号识别
   - 语音命令（如"删除"、"重来"）

2. **AI 规划优化**
   - 支持更多 AI 模型选择
   - 流式输出，实时显示生成过程
   - 支持对 AI 生成内容的反馈和优化

3. **用户体验提升**
   - 保存多个 AI 生成方案供选择
   - AI 生成内容的富文本编辑
   - 支持导出 PDF/图片分享

---

## 📝 更新日志

### v1.0.0 (2024-11-05)
- ✅ 实现浏览器语音识别功能
- ✅ 集成阿里云通义千问 AI
- ✅ 创建 VoiceInput 组件
- ✅ 创建 LLMService 服务
- ✅ 添加 AI 路由端点
- ✅ 更新数据库 schema 支持 description 和 itinerary
- ✅ 完善行程创建页面 UI
- ✅ 添加 AI 计划展示模块

---

**需要帮助？** 查看项目文档或联系开发团队。
